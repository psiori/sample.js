/*!
 * Sample.js - Sends tracking events to 5d's analytics service. v0.0.1
 * http://www.5dlab.com
 *
 * Copyright (c) 2014-2014, Sascha Lange, JoÃ£o Alves
 * Licensed under the MIT License.
 *
 */

!function(a){var b=function(){var a={send:function(a,b,c,d){var e=JSON.stringify(b),f=new XMLHttpRequest;f.addEventListener("load",function(){c&&c()},!0),f.addEventListener("error",function(){d&&d()}),f.open("POST",a),f.setRequestHeader("Content-type","application/json; charset=utf-8"),f.setRequestHeader("Content-length",e.length),f.setRequestHeader("Connection","close"),f.send(e)}};return a}(),c=(function(){var a={};return a}(),function(){return{callback:function(){},events:[]}}),d=function(){var a=[],d=c(),e=!1,f=!1,g=null,h=!1,i={start:function(){f||(f=!0,g=setInterval(function(){i.sendNext()},1e3))},stop:function(){f&&(f=!1,clearTimeout(g))},isRunning:function(){return f===!0},length:function(){return a.length},isEmpty:function(){return 0===a.length},isSending:function(){return e===!0},startGroup:function(){h=!0},endGroup:function(){var a=d;h=!1,0!==d.events.length&&(d=c(),this.add(a.events,a.callback))},isGroup:function(){return h},add:function(b,c){if(h){if(c){var e=d.callback;d.callback=function(){c.apply(this,arguments),e.apply(this,arguments)}}d.events[d.events.length]=b}else a[a.length]={event:b,callback:c},this.sendNext()},sendNext:function(){if(f&&!e&&!this.isEmpty()){e=!0;var c=a[0],d=(JSON.stringify({p:c.event}),this),g=q.getEndpoint(),h={p:c.event},i=function(){a.shift(),e=!1,d.sendNext()},j=function(){e=!1};b.send(g,h,i,j)}}};return i.start(),i}(),e="http://events.neurometry.com/sample/v01/event",f=null,g=null,h=null,i=null,j=null,k=null,l=null,m=!1,n=null,o=function(a,b){var c={},d=function(a,b){a&&"undefined"!=typeof b&&("number"==typeof b||b)&&(c[a]=b)};return d("event_name",b),d("app_token",g),d("install_token",f),d("session_token",h),d("debug",m),d("timestamp",Math.round((new Date).getTime()/1e3)),d("user_id",j),d("event_category",a.event_category),d("module",a.module||i),d("content_id",a.content_id),d("content_ids",a.content_ids),d("content_type",a.content_type),("sessionStart"===b||"sessionUpdate"===b)&&(d("email",a.email||k),d("platform",a.platform||l)),c},p=function(a){for(var b="",c=0;a>c;++c)c>0&&c%4===0&&(b+="-"),b+=Math.floor(16*Math.random()).toString(16).toUpperCase();return b},q={safariOnly:!1,PLATFORM_BROWSER:"browser",PLATFORM_IOS:"ios",PLATFORM_ANDROID:"android",PLATFORM_WINDOWS:"windows",PLATFORM_FACEBOOK:"facebook",init:function(){localStorage.getItem("SampleToken")?f=localStorage.getItem("SampleToken"):localStorage.setItem("SampleToken",f=p(24)),sessionStorage.getItem("SampleToken")?h=sessionStorage.getItem("SampleToken"):sessionStorage.setItem("SampleToken",h=p(32)),l=this.PLATFORM_BROWSER},stop:function(){d.stop()},resume:function(){d.start()},setEndpoint:function(a){e=a},getEndpoint:function(){return e},setAppToken:function(a){g=a},setModule:function(a){i=a},setPlatform:function(a){l=a},setUserId:function(a){j=a},setEmail:function(a){k=a},setDebug:function(a){m=a},startGroup:function(){d.startGroup()},endGroup:function(){d.endGroup()},track:function(a,b){(this.safariOnly!==!0||this.isSafari())&&(b=o(b||{},a),d.add(b,function(){}))},sessionStart:function(a){g=a||g,this.track("session_start",{event_category:"session"})},sessionUpdate:function(){this.track("session_update",{event_category:"session"})},ping:function(){this.track("ping",{event_category:"session"})},autoPing:function(a){var b=this;"undefined"==typeof a&&(a=60),clearTimeout(n),n=null,a&&a>0&&(n=setInterval(function(){b.ping()},1e3*a))},contentUsage:function(a,b){b=b||"content";var c={content_type:b,event_category:"content"};Array.isArray(a)?c.content_ids=a:c.content_id=a,this.track("usage",c)},isSafari:function(){var a=null;return function(){if(null===a){var b=navigator.userAgent.toLowerCase();a=-1!=b.indexOf("safari")?b.indexOf("chrome")>-1?!1:!0:!1}return a}}()};q.init(),a.Sample=q}(window);
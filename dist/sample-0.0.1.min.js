/*!
 * Sample.js - Sends tracking events to 5d's analytics service. v0.0.1
 * http://www.5dlab.com
 *
 * Copyright (c) 2014-2014, Sascha Lange, JoÃ£o Alves
 * Licensed under the MIT License.
 *
 */

!function(a){var b=function(){return{callback:function(){},events:[]}},c=function(){var a=[],c=b(),d=!1,e=!1,f=null,g=!1,h={start:function(){e||(e=!0,f=setInterval(function(){h.sendNext()},1e3))},stop:function(){e&&(e=!1,clearTimeout(f))},isRunning:function(){return e===!0},length:function(){return a.length},isEmpty:function(){return 0===a.length},isSending:function(){return d===!0},startGroup:function(){g=!0},endGroup:function(){var a=c;g=!1,0!==c.events.length&&(c=b(),this.add(a.events,a.callback))},add:function(b,d){if(g){if(d){var e=c.callback;c.callback=function(){d.apply(this,arguments),e.apply(this,arguments)}}c.events[c.events.length]=b}else a[a.length]={event:b,callback:d},this.sendNext()},sendNext:function(){if(e&&!d&&!this.isEmpty()){d=!0;var b=a[0],c=JSON.stringify({p:b.event}),f=this,g=new XMLHttpRequest;g.addEventListener("load",function(){a.shift(),d=!1,f.sendNext()},!0),g.addEventListener("error",function(){d=!1}),g.open("POST",p.getEndpoint()),g.setRequestHeader("Content-type","application/json; charset=utf-8"),g.setRequestHeader("Content-length",c.length),g.setRequestHeader("Connection","close"),g.send(c)}}};return h.start(),h}(),d="http://events.neurometry.com/sample/v01/event",e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=!1,m=null,n=function(a,b){var c={},d=function(a,b){a&&"undefined"!=typeof b&&("number"==typeof b||b)&&(c[a]=b)};return d("event_name",b),d("app_token",f),d("install_token",e),d("session_token",g),d("debug",l),d("timestamp",Math.round((new Date).getTime()/1e3)),d("user_id",i),d("event_category",a.event_category),d("module",a.module||h),d("content_id",a.content_id),d("content_ids",a.content_ids),("sessionStart"===b||"sessionUpdate"===b)&&(d("email",a.email||j),d("platform",a.platform||k)),c},o=function(a){for(var b="",c=0;a>c;++c)c>0&&c%4===0&&(b+="-"),b+=Math.floor(16*Math.random()).toString(16).toUpperCase();return b},p={safariOnly:!1,PLATFORM_BROWSER:"browser",PLATFORM_IOS:"ios",PLATFORM_ANDROID:"android",PLATFORM_WINDOWS:"windwos",PLATFORM_FACEBOOK:"facebook",init:function(){localStorage.SampleToken?e=localStorage.SampleToken:localStorage.SampleToken=e=o(24),sessionStorage.SampleToken?g=sessionStorage.SampleToken:sessionStorage.SampleToken=g=o(32),k=this.PLATFORM_BROWSER},stop:function(){c.stop()},resume:function(){c.start()},setEndpoint:function(a){d=a},getEndpoint:function(){return d},setAppToken:function(a){f=a},setModule:function(a){h=a},setPlatform:function(a){k=a},setUserId:function(a){i=a},setEmail:function(a){j=a},setDebug:function(a){l=a},startGroup:function(){c.startGroup()},endGroup:function(){c.endGroup()},track:function(a,b){(this.safariOnly!==!0||this.isSafari())&&(b=n(b||{},a),c.add(b,function(){}))},sessionStart:function(a){f=a||f,this.track("session_start",{event_category:"session"})},sessionUpdate:function(){this.track("session_update",{event_category:"session"})},ping:function(){this.track("ping",{event_category:"session"})},autoPing:function(a){var b=this;"undefined"==typeof a&&(a=60),clearTimeout(m),a&&a>0&&(m=setInterval(function(){b.ping()},1e3*a))},contentUsage:function(a,b){b=b||"content";var c={content_type:b,event_category:"content"};Array.isArray(a)?c.content_ids=a:c.content_id=a,this.track("usage",c)},isSafari:function(){var a=null;return function(){if(null===a){var b=navigator.userAgent.toLowerCase();a=-1!=b.indexOf("safari")?b.indexOf("chrome")>-1?!1:!0:!1}return a}}()};p.init(),a.Sample=p}(window);
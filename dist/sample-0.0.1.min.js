/*!
 * Sample.js - Sends tracking events to 5d's analytics service. v0.0.1
 * http://www.5dlab.com
 *
 * Copyright (c) 2014-2014, Sascha Lange, Jo√£o Alves
 * Licensed under the MIT License.
 *
 */

!function(a){var b=function(){var a={send:function(a,b,c,d){var e=JSON.stringify(b),f=new XMLHttpRequest;f.addEventListener("load",function(){c&&c()},!0),f.addEventListener("error",function(){d&&d()}),f.open("POST",a),f.setRequestHeader("Content-type","application/json; charset=utf-8"),f.send(e)}};return a}(),c=function(a){return"undefined"==typeof Array.isArray?Array.isArray(a):"[object Array]"===Object.prototype.toString.call(a)},d=function(a,b,c){return c+"["+a+"]="+encodeURIComponent(b)},e=function(a,b){var c=[];for(var e in a)a.hasOwnProperty(e)&&(c[c.length]=d(e,a[e],b));return c},f=function(a,b){for(var c=[],d=0;d<a.length;d++)c[c.length]=e(a[d],b+"["+d+"]").join("&");return c},g=function(){var a=9900,b=function(b,c,d){var e=document.getElementsByTagName("body")[0],f=document.createElement(b?"iframe":"img"),g="sample-key-"+a++;f.src=c,f.id=g,f.style.width=b?"1px":"0",f.style.height=b?"1px":"0",f.style.border="0",f.style.margin="0",f.style.padding="0",f.style.position="fixed",f.style.left="0",f.style.top="0",setTimeout(function(){e.removeChild(f),d&&d()},500),e.insertBefore(f,e.childNodes[0])},d={useIFrame:!1,send:function(a,d,g){var h="";c(d.p)?h=f(d.p,"p").join("&"):"object"==typeof d.p&&(h=e(d.p,"p").join("&")),a+=-1===a.indexOf("?")?"?"+h:"&"+h,b(this.useIFrame,a,g)}};return d}(),h=function(){return{callback:function(){},events:[]}},i=function(){var a=[],c=h(),d=!1,e=!1,f=null,i=!1,j={useXHR:!0,start:function(){e||(e=!0,f=setInterval(function(){j.sendNext()},1e3))},stop:function(){e&&(e=!1,clearTimeout(f))},isRunning:function(){return e===!0},setRequestMethod:function(a){this.useXHR="xhr"===a,this.useXHR||(g.useIFrame="iframe"===a)},length:function(){return a.length},isEmpty:function(){return 0===a.length},isSending:function(){return d===!0},startGroup:function(){i=!0},endGroup:function(){var a=c;i=!1,0!==c.events.length&&(c=h(),this.add(a.events,a.callback))},isGroup:function(){return i},add:function(b,d){if(i){if(d){var e=c.callback;c.callback=function(){d.apply(this,arguments),e.apply(this,arguments)}}c.events[c.events.length]=b}else a[a.length]={event:b,callback:d},this.sendNext()},sendNext:function(){if(e&&!d&&!this.isEmpty()){d=!0;var c=a[0],f=(JSON.stringify({p:c.event}),this),h=B.getEndpoint(),i={p:c.event},j=function(){a.shift(),d=!1,f.sendNext()},k=function(){d=!1};this.useXHR?b.send(h,i,j,k):g.send(h,i,j,k)}}};return j.start(),j}(),j="http://events.neurometry.com/sample/v01/event",k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=null,t=null,u=null,v=null,w=null,x=null,y=!1,z=function(a,b,c){var d={},e=function(a,b){a&&"undefined"!=typeof b&&("number"==typeof b||b)&&(d[a]=b)};return e("event_name",b),e("app_token",l),e("install_token",k),e("session_token",m),e("debug",y),e("timestamp",Math.round((new Date).getTime()/1e3)),e("user_id",o),e("event_category",c||"custom"),e("module",a.module||n),e("content_id",a.content_id),e("content_ids",a.content_ids),e("content_type",a.content_type),e("parameter1",a.parameter1),e("parameter2",a.parameter2),e("parameter3",a.parameter3),e("parameter4",a.parameter4),e("parameter5",a.parameter5),e("parameter6",a.parameter6),("sessionStart"===b||"sessionUpdate"===b||c&&"account"===c)&&(e("email",a.email||p),e("platform",a.platform||q),e("locale",a.locale||w),e("add_referer",a.referer||t),e("add_campaign",a.campaign||u),e("add_placement",a.placement||v),e("longitute",a.longitude||r),e("latitude",a.latitude||s)),d},A=function(a){for(var b="",c=0;a>c;++c)c>0&&c%4===0&&(b+="-"),b+=Math.floor(16*Math.random()).toString(16).toUpperCase();return b},B={PLATFORM_BROWSER:"browser",PLATFORM_IOS:"ios",PLATFORM_ANDROID:"android",PLATFORM_WINDOWS:"windows",PLATFORM_FACEBOOK:"facebook",init:function(){localStorage.getItem("SampleToken")?k=localStorage.getItem("SampleToken"):localStorage.setItem("SampleToken",k=A(24)),sessionStorage.getItem("SampleToken")?m=sessionStorage.getItem("SampleToken"):sessionStorage.setItem("SampleToken",m=A(32)),q=this.PLATFORM_BROWSER,i.setRequestMethod(this.isWebkit()?"xhr":"iframe")},stop:function(){i.stop()},resume:function(){i.start()},setEndpoint:function(a){j=a},getEndpoint:function(){return j},setRequestMethod:function(a){i.setRequestMethod(a)},setAppToken:function(a){l=a},setModule:function(a){n=a},setPlatform:function(a){q=a},setUserId:function(a){o=a},setFacebookId:function(a){facebookId=a},setEmail:function(a){p=a},setLocation:function(a,b){r=newLogitude,s=b},setLocale:function(a){w=a},setReferer:function(a,b,c){t=a||null,u=b||null,v=c||null},setDebug:function(a){y=a},startGroup:function(){i.startGroup()},endGroup:function(){i.endGroup()},track:function(a,b,c){this.isIE()||(c=z(c||{},a,b),i.add(c,function(){}))},sessionStart:function(a){l=a||l,this.track("session_start","session")},sessionUpdate:function(){this.track("session_update","session")},sessionPause:function(){this.track("session_pause","session")},sessionResume:function(){this.track("session_resume","session")},ping:function(){this.track("ping","session")},autoPing:function(a){var b=this;"undefined"==typeof a&&(a=60),clearTimeout(x),x=null,a&&a>0&&(x=setInterval(function(){b.ping()},1e3*a))},registration:function(a,b){o=a||o,this.track("registration","account",b)},signIn:function(a,b){o=a||o,this.track("sign_in","account",b)},contentUsage:function(a,b){b=b||"content";var c={content_type:b};Array.isArray(a)?c.content_ids=a:c.content_id=a,this.track("usage","content",c)},isWebkit:function(){var a=null;return function(){if(null===a){var b=navigator.userAgent.toLowerCase();a=-1!==b.indexOf("safari")||-1!==b.indexOf("chrome")}return a}}(),isIE:function(){var a=null;return function(){if(null===a){var b=navigator.userAgent;a=-1!==b.indexOf("MSIE")||b.indexOf("Trident/")>0}return a}}()};B.init(),a.Sample=B}(window);